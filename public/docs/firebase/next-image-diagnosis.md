# Firebase App Hosting: Next.js Image 404エラーの原因と診断方法

## 概要

この記事では、Firebase App HostingでNext.jsのImageコンポーネントが404エラーになる原因を、**ビルド・ホスティング・ロールアウトの各フェーズ**に分けて詳細に解説し、原因を特定するための診断方法を説明します。

関連記事：[概要と画像配信の仕組み](./next-image-404.md) | [解決策と実装パターン](./next-image-fix.md)

## 404エラーの原因：デプロイフローの各フェーズでの問題

Firebase App Hostingでのデプロイは、以下の3つのフェーズで構成されます：

1. **ビルド（Build）フェーズ**
2. **ホスティング（Runtime）フェーズ**
3. **ロールアウト（Deployment）フェーズ**

それぞれのフェーズで発生する可能性のある問題を詳しく解説します。

### 1. ビルド（Build）フェーズでの問題

#### 問題1.1: `public`ディレクトリがビルド成果物に含まれていない

**原因：**
Firebase App Hostingのビルドプロセスで、`.next`フォルダ（プログラム本体）だけがコピーされ、`public`フォルダがコピーされていない場合があります。

**確認方法：**
```bash
# ローカルでビルドを実行
pnpm build

# ビルド成果物を確認
ls -la .next/
# publicディレクトリの内容が出力ディレクトリに含まれているか確認
```

**症状：**
- 直接 `https://your-domain.com/logo.png` にアクセスしても404になる
- Imageコンポーネントを通さず、静的ファイルとしてもアクセスできない

#### 問題1.2: `next.config.ts`の設定による影響

`next.config.ts`で以下のような設定をしている場合、画像の配信方法に影響を与える可能性があります：

```typescript
// next.config.ts
const nextConfig: NextConfig = {
  output: 'standalone',  // スタンドアロンビルド
  basePath: '/custom-path',  // ベースパスの設定
  // ...
};
```

**`output: 'standalone'`の場合：**
- 最小限のファイルのみが出力される
- `public`ディレクトリの内容が正しくコピーされない場合がある
- Firebase App Hostingでは通常、この設定は不要

**`basePath`が設定されている場合：**
- 画像パスも`basePath`を含める必要がある
- 例：`basePath: '/app'`の場合、`src="/app/logo.png"`とする必要がある

### 2. ホスティング（Runtime）フェーズでの問題

#### 問題2.1: Image Optimizerサーバーの権限不足

**原因：**
Firebase App Hostingのランタイム環境で、Next.jsのImage Optimizerが画像ファイルにアクセスする権限がない場合があります。

**処理フロー：**
1. ブラウザが `/_next/image?url=%2Flogo.png&w=100&q=75` にリクエスト
2. Next.jsのImage Optimizerが`public/logo.png`を読み込もうとする
3. ファイルシステムへのアクセス権限がない、またはファイルが存在しない
4. 404エラーが返される

**症状：**
- `/_next/image`へのリクエストが404を返す
- 直接 `https://your-domain.com/logo.png` にはアクセスできる（静的ファイルとして配信される場合）

#### 問題2.2: 静的アセットと動的ルートの振り分け失敗

Firebase App Hostingは、静的ファイルと動的ルートを自動的に振り分けますが、この振り分けが正しく機能しない場合があります。

**期待される動作：**
- `/logo.png` → 静的ファイルとして直接配信
- `/_next/image?url=...` → Next.jsアプリケーション（動的ルート）で処理

**問題が発生する場合：**
- `/_next/image`へのリクエストが静的ファイルとして扱われ、404になる
- または、静的ファイルへのリクエストが動的ルートとして処理され、正しく配信されない

#### 問題2.3: サーバーレス環境の制約

Firebase App Hostingはサーバーレス環境で動作するため、以下の制約があります：

- **書き込み権限の制限：** Image Optimizerがキャッシュファイルを作成するディレクトリに書き込み権限がない
- **一時ファイルの制約：** 最適化処理で作成される一時ファイルが保存できない
- **メモリ制限：** 大きな画像の最適化処理でメモリ不足が発生する可能性

### 3. ロールアウト（Deployment）フェーズでの問題

#### 問題3.1: CDNキャッシュの影響

Firebase App Hostingは、ビルド済みの静的ファイルをCDN（エッジ）に展開します。

**問題が発生する場合：**
- 以前のビルドの設定がCDNにキャッシュされている
- 新しいパスの画像が認識されるまで時間がかかる
- デプロイ直後に404エラーが発生し、時間が経つと解決する

**確認方法：**
```bash
# デプロイ後に、直接画像URLにアクセス
curl -I https://your-domain.com/logo.png

# キャッシュを無視してアクセス
curl -I -H "Cache-Control: no-cache" https://your-domain.com/logo.png
```

#### 問題3.2: デプロイ設定の不整合

`apphosting.yaml`の設定が、実際のビルドプロセスと一致していない場合があります。

**確認すべき設定：**
```yaml
# apphosting.yaml
build:
  commands:
    - pnpm install
    - pnpm build
```

**問題が発生する場合：**
- ビルドコマンドが正しく実行されていない
- ビルド成果物が正しくデプロイされていない
- 環境変数が正しく設定されていない

## 原因の特定方法：段階的な診断

### ステップ1: 直接アクセステスト

Imageコンポーネントを通さず、画像に直接アクセスして確認します。

```bash
# ブラウザのURLバーに直接入力
https://your-domain.com/logo.png
```

**結果の解釈：**
- ✅ **表示される：** `public`ディレクトリは正しくデプロイされている。Imageコンポーネントの設定か、Image Optimizerの問題。
- ❌ **404エラー：** `public`ディレクトリがデプロイされていない。ビルド・デプロイ設定の問題。

### ステップ2: `unoptimized`オプションでテスト

Image Optimizerをバイパスして、画像をそのまま配信する設定でテストします。

```tsx
<Image
  src="/logo.png"
  alt="Logo"
  width={100}
  height={40}
  unoptimized  // 最適化を無効化
/>
```

**結果の解釈：**
- ✅ **表示される：** Image Optimizerの問題。ランタイム環境での画像最適化が機能していない。
- ❌ **404エラー：** `public`ディレクトリの問題。ビルド・デプロイ設定を確認。

### ステップ3: ビルドログの確認

Firebase App Hostingのビルドログを確認して、`public`ディレクトリが正しく処理されているか確認します。

**確認ポイント：**
- `public`ディレクトリの内容がコピーされているか
- 画像ファイルがビルド成果物に含まれているか
- エラーや警告が出力されていないか

### ステップ4: ローカルビルドでの確認

ローカル環境で本番ビルドを実行して、問題を再現できるか確認します。

```bash
# 本番ビルドを実行
pnpm build

# 本番モードで起動
pnpm start

# ブラウザで確認
# http://localhost:3000/logo.png
```

**結果の解釈：**
- ✅ **ローカルで表示される：** Firebase App Hostingのデプロイ設定の問題。
- ❌ **ローカルでも404：** Next.jsの設定やプロジェクト構成の問題。

## 診断フローチャート

```
画像が404エラーになる
│
├─ 直接アクセス（/logo.png）で確認
│  │
│  ├─ ✅ 表示される
│  │  └─ Image Optimizerの問題
│  │     └─ unoptimizedオプションで確認
│  │        ├─ ✅ 表示される → Image Optimizerの問題確定
│  │        └─ ❌ 404エラー → Imageコンポーネントの設定を確認
│  │
│  └─ ❌ 404エラー
│     └─ publicディレクトリがデプロイされていない
│        └─ ビルドログを確認
│           ├─ publicがコピーされていない → ビルド設定の問題
│           └─ ローカルビルドで確認
│              ├─ ✅ ローカルで表示される → デプロイ設定の問題
│              └─ ❌ ローカルでも404 → Next.js設定の問題
```

## まとめ

404エラーの原因は、主に以下の3つのフェーズで発生します：

1. **ビルドフェーズ：** `public`ディレクトリがビルド成果物に含まれていない、または`next.config.ts`の設定による影響
2. **ホスティングフェーズ：** Image Optimizerサーバーの権限不足、静的ファイルと動的ルートの振り分け失敗、サーバーレス環境の制約
3. **ロールアウトフェーズ：** CDNキャッシュの影響、デプロイ設定の不整合

段階的な診断を行うことで、問題が発生しているフェーズを特定できます。次の記事では、これらの問題に対する実践的な解決策を解説します。

## 参考リンク

- [概要と画像配信の仕組み](./next-image-404.md)
- [解決策と実装パターン](./next-image-fix.md)
- [Firebase App Hosting: Secret Manager 権限付与マニュアル](./secret-manager-setup.md)

